<!DOCTYPE html>
<html>
    <head>
        <link rel="icon" href="favicon.ico">
        <script src="phaser.min.js"></script>
    </head>
    <body>
        <script>
        var config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { x: 0, y: 0 }
                }
            },
            scene: {
                preload: preload,
                create: create
            }
        };
    
        var game = new Phaser.Game(config);

        console.log(game);
    
        function preload ()
        {
            this.load.image('spaceship', 'assets/sprites/spaceship-1.png');
            this.load.spritesheet('ship', 'assets/sprites/spaceship-1-sheet.png', {frameWidth: 64, frameHeight: 64});
            this.load.image('fireball', 'assets/sprites/fireball.png');
            this.load.image('red', 'assets/particles/red.png');
        }
    
        function create ()
        {
            this.anims.create({
                key: "ship",
                frames: this.anims.generateFrameNumbers("ship"),
                frameRate: 0,
                repeat: -1
            });
    
            this.player = this.physics.add.sprite(70, 300, 'ship');
            
            this.KeyUp = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP);
            this.KeyDown = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN);
            this.KeyLeft = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT);
            this.KeyRight = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT);
            this.KeyZ = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z);

            this.playerShootDelay = 30;
            this.playerShootTick = 0;

            this.playerLasers = this.add.group();

            updatePlayerMovement.bind(this)();
            updatePlayerShooting.bind(this)();
            updateLasers.bind(this)();
            this.redParticles = this.add.particles('red');

            /*var logo = this.physics.add.image(100, 100, 'logo');
    
            logo.setVelocity(100, 200);
            logo.setBounce(1, 1);
            logo.setCollideWorldBounds(true);
    
            emitter.startFollow(logo);*/
        }

        function updatePlayerMovement() {
            this.time.addEvent({
                delay: 30,
                callback: function() {
                    if (this.KeyUp.isDown) {
                        this.player.y -= 6;
                        this.player.setFrame(1);
                    }
                    if (this.KeyDown.isDown) {
                        this.player.y += 6;
                        this.player.setFrame(2);
                    }
                    if (this.KeyRight.isDown) {
                        this.player.x += 6;
                    }
                    if (this.KeyLeft.isDown) {
                        this.player.x -= 6;
                    }
                    if (!this.KeyUp.isDown && !this.KeyDown.isDown) {
                        this.player.setFrame(0);
                    }
                },
                callbackScope: this,
                loop: true
            });
        }
        
        function updatePlayerShooting() {
            this.time.addEvent({
                delay: 15,
                callback: function() {
                    this.playerShootTick++;
                    if (this.KeyZ.isDown && this.player.active) {
                        if (this.playerShootTick > this.playerShootDelay) {
                            var laser = this.physics.add.sprite(this.player.x, this.player.y, 'fireball');
                            this.playerLasers.add(laser);

                            var laserParticles = this.redParticles.createEmitter({
                                speed: 100,
                                scale: { start: 1, end: 0 },
                                blendMode: 'ADD'
                            });

                            console.log(laserParticles)
                            //this.sfx.laserPlayer.play();
                            laserParticles.startFollow(laser);
                            laser.particleRef = laserParticles;
                            this.playerShootTick = 0;
                        }
                    }	
                },
                callbackScope: this,
                loop: true
            });
        }

        function updateLasers() {
            this.time.addEvent({
                delay: 30,
                callback: function() {
                    for (var i = 0; i < this.playerLasers.getChildren().length; i++) {
                        var laser = this.playerLasers.getChildren()[i];
                    
                        laser.x += laser.displayWidth;
                    
                        if (laser.x > 800) {
                            //this.createExplosion(laser.x, laser.y);
                    
                            if (laser) {
                                laser.particleRef.explode();
                                laser.destroy();
                            }
                        }
                    }
                },
                callbackScope: this,
                loop: true
            });
            
            /* this.time.addEvent({
                delay: 128,
                callback: function() {
                    for (var i = 0; i < this.enemyLasers.getChildren().length; i++) {
                    var laser = this.enemyLasers.getChildren()[i];
                
                    laser.y += laser.displayHeight;
                    }
                },
                callbackScope: this,
                loop: true
            }); */
        }
        </script>
    </body>
</html>